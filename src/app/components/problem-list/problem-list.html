<div class="problem-list-container">
  <div class="header-section">
    <h2>Problems</h2>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="addProblem()">
        <mat-icon>add</mat-icon>
        Add Problem
      </button>

      <button mat-raised-button color="accent" (click)="openSearchDialog()">
        <mat-icon>search</mat-icon>
        Search Problems
      </button>

      <button mat-raised-button (click)="openImportDialog()">
        <mat-icon>cloud_download</mat-icon>
        Import from LeetCode
      </button>

      <!-- Column Options Button -->
      <button mat-raised-button [matMenuTriggerFor]="columnMenu">
        <mat-icon>view_column</mat-icon>
        Columns
      </button>

      <mat-menu #columnMenu="matMenu" class="column-menu">
        <div class="column-menu-header">
          <h3>Column Visibility</h3>
          <button mat-icon-button (click)="resetColumns()" matTooltip="Reset to default">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
        <mat-divider></mat-divider>

        <div class="column-section">
          <h4>Visible Columns</h4>
          <button
            *ngFor="let column of visibleColumns"
            mat-menu-item
            (click)="hideColumn(column.key)"
            class="column-item visible-column"
          >
            <mat-icon>visibility</mat-icon>
            <span>{{ column.label }}</span>
            <mat-icon class="hide-icon">visibility_off</mat-icon>
          </button>
        </div>

        <div class="column-section" *ngIf="hiddenColumns.length > 0">
          <mat-divider></mat-divider>
          <h4>Hidden Columns</h4>
          <button
            *ngFor="let column of hiddenColumns"
            mat-menu-item
            (click)="showColumn(column.key)"
            class="column-item hidden-column"
          >
            <mat-icon>visibility_off</mat-icon>
            <span>{{ column.label }}</span>
            <mat-icon class="show-icon">visibility</mat-icon>
          </button>
        </div>

        <mat-divider></mat-divider>
        <div class="column-hint">
          <mat-icon>info</mat-icon>
          <span>Click on column cells to quick edit. Drag column borders to resize.</span>
        </div>
      </mat-menu>
    </div>
  </div>

  <div class="filters-section">
    <mat-form-field appearance="outline">
      <mat-label>Search</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Search problems..." />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Difficulty</mat-label>
      <mat-select (selectionChange)="filterByDifficulty($event.value)" [value]="''">
        <mat-option value="">All</mat-option>
        <mat-option value="Easy">Easy</mat-option>
        <mat-option value="Medium">Medium</mat-option>
        <mat-option value="Hard">Hard</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Status</mat-label>
      <mat-select (selectionChange)="filterByStatus($event.value)" [value]="''">
        <mat-option value="">All</mat-option>
        <mat-option value="Not Attempted">Not Attempted</mat-option>
        <mat-option value="Attempted">Attempted</mat-option>
        <mat-option value="Solved">Solved</mat-option>
        <mat-option value="Reviewed">Reviewed</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Company</mat-label>
      <mat-select (selectionChange)="filterByCompany($event.value)" [value]="''">
        <mat-option value="">All Companies</mat-option>
        <mat-option *ngFor="let company of availableCompanies" [value]="company">
          {{ company }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="table-container" [class.resizing]="isResizing">
    <table mat-table [dataSource]="dataSource" matSort class="problems-table resizable-table">
      <!-- ID Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          ID
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'id')"></div>
        </th>
        <td mat-cell *matCellDef="let problem">{{ problem.leetcodeId }}</td>
      </ng-container>

      <!-- Title Column -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          Title
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'title')"></div>
        </th>
        <td mat-cell *matCellDef="let problem">
          <a [href]="problem.url" target="_blank" class="title-link">
            {{ problem.title }}
          </a>
        </td>
      </ng-container>

      <!-- Difficulty Column - Clickable -->
      <ng-container matColumnDef="difficulty">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          Difficulty
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'difficulty')"></div>
        </th>
        <td
          mat-cell
          *matCellDef="let problem"
          class="clickable-cell"
          (click)="onColumnClick('difficulty', problem, $event)"
          matTooltip="Click to edit difficulty"
        >
          <span class="difficulty-badge" [class]="'difficulty-' + problem.difficulty.toLowerCase()">
            {{ problem.difficulty }}
          </span>
        </td>
      </ng-container>

      <!-- Status Column - Clickable -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          Status
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'status')"></div>
        </th>
        <td
          mat-cell
          *matCellDef="let problem"
          class="clickable-cell"
          (click)="onColumnClick('status', problem, $event)"
          matTooltip="Click to edit status"
        >
          <span
            class="status-badge"
            [class]="'status-' + problem.status.replace(' ', '-').toLowerCase()"
          >
            {{ problem.status }}
          </span>
        </td>
      </ng-container>

      <!-- Tags Column - Clickable -->
      <ng-container matColumnDef="tags">
        <th mat-header-cell *matHeaderCellDef class="resizable-header">
          Tags
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'tags')"></div>
        </th>
        <td
          mat-cell
          *matCellDef="let problem"
          class="clickable-cell"
          (click)="onColumnClick('tags', problem, $event)"
          matTooltip="Click to edit tags"
        >
          <div class="tags-container">
            <mat-chip *ngFor="let tag of problem.tags.slice(0, 2)">{{ tag }}</mat-chip>
            <span class="more-tags" *ngIf="problem.tags.length > 2">
              +{{ problem.tags.length - 2 }} more
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Companies Column - Clickable -->
      <ng-container matColumnDef="companies">
        <th mat-header-cell *matHeaderCellDef class="resizable-header">
          Companies
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'companies')"></div>
        </th>
        <td
          mat-cell
          *matCellDef="let problem"
          class="clickable-cell"
          (click)="onColumnClick('companies', problem, $event)"
          matTooltip="Click to edit companies"
        >
          <div
            class="company-logos-container"
            *ngIf="problem.companies && problem.companies.length > 0"
          >
            <div
              class="company-logo-wrapper"
              *ngFor="let company of problem.companies.slice(0, 3)"
              [title]="company"
            >
              <img
                [src]="getCompanyLogo(company)"
                [alt]="company + ' logo'"
                class="company-logo-small"
                (error)="onCompanyImageError($event, company)"
              />
            </div>
            <span class="more-companies" *ngIf="problem.companies.length > 3">
              +{{ problem.companies.length - 3 }}
            </span>
          </div>
          <span *ngIf="!problem.companies || problem.companies.length === 0" class="no-companies"
            >â€”</span
          >
        </td>
      </ng-container>

      <!-- Attempts Column - Clickable -->
      <ng-container matColumnDef="attempts">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          Attempts
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'attempts')"></div>
        </th>
        <td
          mat-cell
          *matCellDef="let problem"
          class="clickable-cell"
          (click)="onColumnClick('attempts', problem, $event)"
          matTooltip="Click to edit attempts"
        >
          {{ problem.attempts }}
        </td>
      </ng-container>

      <!-- Time Spent Column - Clickable -->
      <ng-container matColumnDef="timeSpent">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          Time (min)
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'timeSpent')"></div>
        </th>
        <td
          mat-cell
          *matCellDef="let problem"
          class="clickable-cell"
          (click)="onColumnClick('timeSpent', problem, $event)"
          matTooltip="Click to edit time spent"
        >
          {{ problem.timeSpent }}
        </td>
      </ng-container>

      <!-- Date Added Column -->
      <ng-container matColumnDef="dateAdded">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="resizable-header">
          Date Added
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'dateAdded')"></div>
        </th>
        <td mat-cell *matCellDef="let problem">
          {{ formatDate(problem.createdAt) }}
        </td>
      </ng-container>

      <!-- Notes Column -->
      <ng-container matColumnDef="notes">
        <th mat-header-cell *matHeaderCellDef class="resizable-header">
          Notes
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'notes')"></div>
        </th>
        <td mat-cell *matCellDef="let problem">
          <button
            mat-icon-button
            (click)="viewNotes(problem)"
            [color]="hasNotes(problem) ? 'primary' : ''"
            [matTooltip]="hasNotes(problem) ? 'View/Edit Notes' : 'Add Notes'"
            class="notes-button"
            [class.has-notes]="hasNotes(problem)"
          >
            <mat-icon>{{ hasNotes(problem) ? 'description' : 'note_add' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="resizable-header">
          Actions
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'actions')"></div>
        </th>
        <td mat-cell *matCellDef="let problem">
          <button mat-icon-button [matMenuTriggerFor]="actionMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #actionMenu="matMenu">
            <button mat-menu-item (click)="viewProblemDetails(problem)" class="action-menu-item">
              <mat-icon>info</mat-icon>
              <span>View Details</span>
            </button>
            <button mat-menu-item (click)="editProblem(problem)" class="action-menu-item">
              <mat-icon>edit</mat-icon>
              <span>Edit</span>
            </button>
            <button mat-menu-item (click)="viewNotes(problem)" class="action-menu-item">
              <mat-icon>description</mat-icon>
              <span>{{ hasNotes(problem) ? 'View/Edit Notes' : 'Add Notes' }}</span>
            </button>
            <button
              mat-menu-item
              (click)="viewAllTags(problem)"
              *ngIf="problem.tags.length > 3"
              class="action-menu-item"
            >
              <mat-icon>local_offer</mat-icon>
              <span>View All Tags</span>
            </button>
            <button mat-menu-item (click)="viewCompanies(problem)" class="action-menu-item">
              <mat-icon>business</mat-icon>
              <span>Companies</span>
            </button>
            <button mat-menu-item (click)="viewTimestamps(problem)" class="action-menu-item">
              <mat-icon>schedule</mat-icon>
              <span>View Timeline</span>
            </button>
            <mat-divider></mat-divider>
            <button
              mat-menu-item
              (click)="deleteProblem(problem)"
              class="action-menu-item delete-action"
            >
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <div class="empty-state" *ngIf="dataSource.data.length === 0">
      <mat-icon>assignment</mat-icon>
      <h3>No problems found</h3>
      <p>Start by adding your first LeetCode problem!</p>
    </div>
  </div>

  <mat-paginator
    [pageSizeOptions]="[5, 10, 20, 50]"
    showFirstLastButtons
    aria-label="Select page of problems"
  >
  </mat-paginator>
</div>
